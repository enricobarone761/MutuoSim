<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcolatore Mutuo Pro</title>
    <!-- Chart.js 4.x -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>

    <div class="container">
        <!-- Sidebar: Inputs -->
        <div class="input-section">
            <div class="card">
                <h1>Mutuo Sim</h1>

                <div class="input-group">
                    <label>Importo Mutuo (‚Ç¨) <span class="info-icon"
                            data-tooltip="Il capitale totale richiesto alla banca.">i</span></label>
                    <input type="number" id="amount" value="160000" step="1000">
                </div>

                <div id="capital-additions-container"></div>
                <div style="margin-bottom: 24px;">
                    <button class="btn btn-add" id="addCapitalAdditionBtn"
                        style="background: rgba(16, 185, 129, 0.05); border: 1px dashed rgba(16, 185, 129, 0.3); color: #10b981; padding: 6px 12px; font-size: 0.8rem; width: auto;">+
                        Aggiunta Capitale <span class="info-icon"
                            data-tooltip="Simula l'erogazione di ulteriore capitale nel tempo (es. ristrutturazione).">i</span></button>
                </div>

                <div class="input-group">
                    <div style="display: flex; justify-content: space-between; align-items: baseline;">
                        <label>Durata (Anni) <span class="info-icon"
                                data-tooltip="La durata complessiva del mutuo. Massimo 30 anni.">i</span></label>
                        <label style="font-size: 0.7rem; color: var(--accent-purple);">Ricalcola anni con Rata
                            Target <span class="info-icon"
                                data-tooltip="Imposta una rata desiderata e trova la durata minima per ottenerla.">i</span></label>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <input type="number" id="years" value="30" step="1" min="1" max="30" style="flex: 1;">
                        <div style="position: relative; flex: 1;">
                            <input type="number" id="targetRata" placeholder="Target ‚Ç¨" step="10"
                                style="width: 100%; padding-right: 35px;">
                            <button id="calcYearsFromRataBtn" title="Ricalcola anni dalla rata target" style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%);
                                background: transparent; border: none; color: #a855f7; cursor: pointer;
                                padding: 4px; display: flex; align-items: center; justify-content: center;
                                transition: color 0.2s;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
                                    <path d="M3 3v5h5" />
                                    <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16" />
                                    <path d="M16 16h5v5" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="input-group">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <label style="margin-bottom: 0;">Tasso Base Annuo <span class="info-icon"
                                data-tooltip="Il tasso d'interesse nominale (TAN) applicato.">i</span></label>
                        <div class="value-badge">
                            <input type="number" id="rateNumeric" value="3.5" step="0.1" min="0" max="25"
                                class="badge-input">
                            <span>%</span>
                        </div>
                    </div>
                    <div class="range-container">
                        <input type="range" id="rate" value="3.5" min="0" max="10" step="0.1" class="volume-slider">
                    </div>
                </div>

                <!-- Tasso Variabile Manuale -->
                <div class="toggle-container">
                    <input type="checkbox" id="isVariable" class="toggle-checkbox">
                    <div>
                        <label for="isVariable" style="margin:0; cursor:pointer; color: #a855f7;">Scenario Variabile
                            Manuale <span class="info-icon"
                                data-tooltip="Pianifica variazioni di tasso personalizzate in mesi specifici.">i</span></label>
                        <small
                            style="display:block; color:var(--text-muted); font-size: 0.75rem; margin-top:2px;">Definisci
                            tassi per periodi futuri.</small>
                    </div>
                </div>

                <div id="variable-section" style="display:none;">
                    <div id="rate-periods-container"></div>
                    <button class="btn btn-add" id="addPeriodBtn">+ Periodo</button>
                </div>

                <!-- Tasso Euribor -->
                <div class="toggle-container"
                    style="background: rgba(59, 130, 246, 0.05); border-left: 4px solid #3b82f6;">
                    <input type="checkbox" id="useEuribor" class="toggle-checkbox" style="accent-color: #3b82f6;">
                    <div>
                        <label for="useEuribor" style="margin:0; cursor:pointer; color: #3b82f6;">Simulazione
                            Euribor <span class="info-icon"
                                data-tooltip="Simula l'andamento del mutuo usando lo storico REALE dell'Euribor.">i</span></label>
                        <small style="display:block; color:var(--text-muted); font-size: 0.75rem; margin-top:2px;">Usa
                            dati storici reali.</small>
                    </div>
                </div>

                <div id="euribor-section" style="display:none;">
                    <p id="euriborStatus" style="font-size: 0.8rem; margin-bottom: 10px;"></p>
                    <div class="input-group">
                        <label>Tipo Euribor</label>
                        <select id="euriborTenor">
                            <option value="1M">1 Mese</option>
                            <option value="3M" selected>3 Mesi</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Data Inizio</label>
                        <input type="month" id="euriborStart" value="1999-01">
                    </div>
                    <div class="input-group">
                        <label>Spread (%)</label>
                        <input type="number" id="euriborSpread" value="0.6" step="0.1" min="0">
                    </div>
                </div>

                <hr>

                <h3>Estinzioni Parziali <span class="info-icon"
                        data-tooltip="Simula versamenti extra una tantum per abbattere il debito residuo e risparmiare interessi.">i</span>
                </h3>
                <div id="extra-payments-container"></div>
                <button class="btn btn-add" id="addExtraPaymentBtn">+ Estinzione Parziale</button>

                <hr style="margin: 20px 0; border: none; border-top: 1px solid rgba(255,255,255,0.1);">

                <h3>Arrotondamento Rata</h3>
                <div class="input-group">
                    <label>Arrotonda Rata a (‚Ç¨) <span class="info-icon"
                            data-tooltip="Arrotonda la rata mensile per eccesso (es. da 827‚Ç¨ a 850‚Ç¨) per estinguere il mutuo prima.">i</span></label>
                    <input type="number" id="roundUpAmount" value="0" step="10" min="0">
                </div>
                <div class="input-group">
                    <label>Mese di Inizio (0=Subito)</label>
                    <input type="number" id="roundUpStartMonth" value="0" step="1" min="0" max="360">
                </div>
                <div class="input-group">
                    <label>Incremento Annuo (%) <span class="info-icon"
                            data-tooltip="Aumenta l'importo dell'arrotondamento ogni anno (es. per inflazione o scatti di carriera).">i</span></label>
                    <input type="number" id="roundUpAnnualIncrease" value="0" step="0.1" min="0" max="50">
                </div>
                <small
                    style="display:block; color:var(--text-muted); font-size: 0.75rem; margin-top:-8px; margin-bottom: 12px;">
                    La differenza tra la rata calcolata e questo importo verr√† applicata come estinzione parziale
                    mensile. L'importo target cresce ogni anno della percentuale indicata (ed √® arrotondato alla decina
                    pi√π vicina).
                </small>
                <h3>Soluzione Ibrida (Mutuo + PL)</h3>
                <div class="toggle-container"
                    style="background: rgba(168, 85, 247, 0.05); border-left: 4px solid #a855f7;">
                    <input type="checkbox" id="hybridToggle" class="toggle-checkbox" style="accent-color: #a855f7;">
                    <div>
                        <label for="hybridToggle" style="margin:0; cursor:pointer; color: #a855f7;">Soluzione Ibrida
                            (Mutuo
                            + Prestito) <span class="info-icon"
                                data-tooltip="Copre la differenza tra il prezzo d'acquisto e il mutuo con un prestito personale (Max 30k‚Ç¨).">i</span></label>
                        <small style="display:block; color:var(--text-muted); font-size: 0.75rem; margin-top:2px;">
                            Sposta parte dell'importo su un prestito separato.
                        </small>
                    </div>
                </div>

                <div id="hybrid-section" style="display:none; padding-top: 10px;">
                    <div class="input-group">
                        <label>Importo Prestito (‚Ç¨)</label>
                        <input type="number" id="hybridLoanAmount" value="30000" step="1000">
                    </div>
                    <div class="input-group">
                        <label>Tasso Prestito (TAEG %)</label>
                        <input type="number" id="hybridLoanRate" value="7.5" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>Durata Prestito (Anni)</label>
                        <input type="number" id="hybridLoanYears" value="10" step="1" min="1" max="30">
                    </div>
                </div>

                <hr style="margin: 20px 0; border: none; border-top: 1px solid rgba(255,255,255,0.1);">

                <div class="top-actions">
                    <button id="openAmortizationBtn" class="btn btn-secondary"
                        data-tooltip="Visualizza la tabella dettagliata mese per mese di tutto il mutuo.">üìä Piano
                        Ammortamento</button>
                    <button id="toggleAdvancedBtn" class="btn btn-secondary"
                        style="margin-top: 10px; background: rgba(168, 85, 247, 0.08); color: var(--accent-purple); border-color: rgba(168, 85, 247, 0.3);">‚öôÔ∏è
                        Funzioni Avanzate</button>
                </div>

            </div>
        </div>

        <!-- Main: Results & Chart -->
        <div class="results-section">
            <div class="results-card">
                <div class="results-header">
                    <div class="results-grid">
                        <div class="result-box rata-toggle" id="rataBox"
                            data-tooltip="La prima rata calcolata. Clicca qui per vedere come cambierebbe se variassero anni o tassi (+/- 0.5%).">
                            <span class="label">Rata Iniziale</span>
                            <span class="value" id="outInitialPayment">--</span>
                            <span class="rata-chevron" id="rataChevron">‚ñº</span>
                        </div>
                        <div class="result-box"
                            data-tooltip="Il picco massimo raggiunto dalla rata (importante per valutarne la sostenibilit√† futura).">
                            <span class="label">Rata Massima</span>
                            <span class="value" id="outMaxPayment">--</span>
                        </div>
                        <div class="result-box"
                            data-tooltip="Il costo vivo del prestito: la somma di soli interessi pagati alla fine di tutto il piano.">
                            <span class="label">Interessi Totali</span>
                            <span class="value" id="outTotalInterest">--</span>
                        </div>
                        <div class="result-box"
                            data-tooltip="La cifra reale complessiva rimborasta: Capitale + Interessi + Spese + Assicurazioni.">
                            <span class="label">Totale Pagato</span>
                            <span class="value" id="outTotalPaid">--</span>
                        </div>

                        <div id="saved-time-box" class="result-box" style="display: none;">
                            <span class="label">‚è±Ô∏è Tempo Risparmiato</span>
                            <span class="value" id="outSavedTime" style="color: #10b981;">--</span>
                        </div>
                    </div>

                    <!-- Pannello Sensibilit√† Rata -->
                    <div id="rataSensitivityPanel" class="sensitivity-panel" style="display: none;">
                        <table class="sensitivity-table">
                            <thead>
                                <tr>
                                    <th class="sensitivity-corner"></th>
                                    <th id="hdr-col-0">--</th>
                                    <th id="hdr-col-1">--</th>
                                    <th id="hdr-col-2">--</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <th id="hdr-row-0">--</th>
                                    <td id="cell-plus5y-plus05r">--</td>
                                    <td id="cell-curr-y-plus05r">--</td>
                                    <td id="cell-minus5y-plus05r">--</td>
                                </tr>
                                <tr>
                                    <th id="hdr-row-1">--</th>
                                    <td id="cell-plus5y-curr-r">--</td>
                                    <td id="cell-curr-y-curr-r" class="sensitivity-current">--</td>
                                    <td id="cell-minus5y-curr-r">--</td>
                                </tr>
                                <tr>
                                    <th id="hdr-row-2">--</th>
                                    <td id="cell-plus5y-minus05r">--</td>
                                    <td id="cell-curr-y-minus05r">--</td>
                                    <td id="cell-minus5y-minus05r">--</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="chart-wrapper">
                    <div class="chart-container">
                        <canvas id="mortgageChart"></canvas>
                    </div>
                    <!-- Range Selector for Chart -->
                    <div class="range-selector-container">
                        <div class="range-slider-wrapper">
                            <div id="rangeTrack" class="range-slider-track"></div>
                            <input type="range" id="chartRangeMin" class="range-slider-input" min="1" max="360"
                                value="1">
                            <input type="range" id="chartRangeMax" class="range-slider-input" min="1" max="360"
                                value="360">
                        </div>
                        <div class="range-label-container">
                            <span id="rangeLabelStart">Inizio: Mese 1</span>
                            <span id="rangeLabelEnd">Fine: Mese 360</span>
                        </div>
                    </div>
                </div>

                <!-- Confronto Ibrido -->
                <div id="hybrid-results"
                    style="display: none; margin-top: 24px; border-top: 2px dashed rgba(168, 85, 247, 0.2); padding-top: 20px;">
                    <h3 style="color: #a855f7; margin-bottom: 16px;">Confronto Soluzione Ibrida</h3>
                    <div class="results-grid">
                        <div class="result-box" style="border-color: rgba(168, 85, 247, 0.3);">
                            <span class="label">Rata Combinata (Mutuo + PL)</span>
                            <span class="value" id="outHybridCombinedRata">--</span>
                            <small style="font-size: 0.65rem; opacity: 0.7;">Durante l'ammortamento del prestito</small>
                        </div>
                        <div class="result-box" style="border-color: rgba(168, 85, 247, 0.3);">
                            <span class="label">Risparmio Interessi</span>
                            <span class="value" id="outHybridInterestSaving">--</span>
                        </div>
                        <div class="result-box" style="border-color: rgba(168, 85, 247, 0.3);">
                            <span class="label">Differenza Totale Life-Cost</span>
                            <span class="value" id="outHybridTotalDiff">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Section (Right Sidebar) -->
        <div class="advanced-section collapsed" id="advancedSection">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h1 style="margin: 0;">Avanzate</h1>
                    <button id="closeAdvancedBtn"
                        style="background: transparent; border: none; font-size: 1.2rem; color: var(--text-muted); cursor: pointer;">‚úï</button>
                </div>

                <h3>Costi Iniziali e TAEG <span class="info-icon"
                        data-tooltip="Spese una tantum (istruttoria, perizia, notaio) che incidono sul costo reale del mutuo.">i</span>
                </h3>
                <div class="input-group">
                    <label>Istruttoria (‚Ç¨)</label>
                    <input type="number" id="costIstruttoria" value="0" step="10" min="0">
                </div>
                <div class="input-group">
                    <label>Perizia (‚Ç¨)</label>
                    <input type="number" id="costPerizia" value="0" step="10" min="0">
                </div>
                <div class="input-group">
                    <label>Notaio (‚Ç¨)</label>
                    <input type="number" id="costNotaio" value="0" step="10" min="0">
                </div>
                <div class="input-group">
                    <label>Imposta Sostitutiva (‚Ç¨)</label>
                    <input type="number" id="costImposta" value="0" step="10" min="0">
                </div>
                <div class="input-group">
                    <label>Assicurazione (Mensile ‚Ç¨) <span class="info-icon"
                            data-tooltip="Costo mensile di polizze vita o scoppio/incendio obbligatorie.">i</span></label>
                    <input type="number" id="costAssicurazione" value="0" step="1" min="0">
                </div>

                <!-- Box risultato TAEG -->
                <div class="result-box"
                    style="margin-top: 16px; margin-bottom: 24px; padding: 12px; border-color: rgba(16, 185, 129, 0.3);">
                    <span class="label">TAEG (Stima) <span class="info-icon"
                            data-tooltip="Il costo reale percentuale del mutuo, comprensivo di interessi e spese accessorie.">i</span></span>
                    <span class="value" id="outTaeg" style="font-size: 1.2rem; color: #10b981;">--</span>
                </div>

                <hr>

                <h3>Detrazioni Fiscali <span class="info-icon"
                        data-tooltip="Recupero del 19% degli interessi passivi (max 4000‚Ç¨/anno) per l'abitazione principale.">i</span>
                </h3>
                <div class="toggle-container"
                    style="background: rgba(16, 185, 129, 0.05); border-left: 4px solid #10b981;">
                    <input type="checkbox" id="calcDetrazione" class="toggle-checkbox" style="accent-color: #10b981;">
                    <div>
                        <label for="calcDetrazione" style="margin:0; cursor:pointer; color: #10b981;">Calcola
                            Detrazione</label>
                        <small
                            style="display:block; color:var(--text-muted); font-size: 0.75rem; margin-top:2px;">(Prima
                            casa, max 4000‚Ç¨/anno)</small>
                    </div>
                </div>
                <div class="result-box"
                    style="margin-top: 16px; margin-bottom: 24px; padding: 12px; border-color: rgba(16, 185, 129, 0.3); display: none;"
                    id="detrazioneBox">
                    <span class="label">Totale Detraibile Recuperato</span>
                    <span class="value" id="outDetrazioneTotale" style="font-size: 1.2rem; color: #10b981;">--</span>
                </div>

                <hr>

                <h3>Investimento Alternativo <span class="info-icon"
                        data-tooltip="Compara il rendimento di un investimento finanziario rispetto al risparmio ottenuto con le estinzioni extra. Richiede che ci siano estinzioni o versamenti extra attivi.">i</span>
                </h3>
                <small style="display:block; color:var(--text-muted); font-size: 0.75rem; margin-bottom: 12px;">
                    Se invece di fare estinzioni extra investissi quegli stessi soldi in un prodotto finanziario (ETF,
                    PAC, ecc.), quanto avresti alla fine del mutuo?
                </small>
                <div class="input-group">
                    <label>Rendimento Annuo Netto Atteso (%)
                        <span class="info-icon"
                            data-tooltip="Inserisci il rendimento annuo al netto di tasse e commissioni. Il mercato azionario storico √® circa 7-8%, un BTP circa 3-4%, un conto deposito circa 3%.">i</span>
                    </label>
                    <input type="number" id="investmentRate" value="4.0" step="0.1" min="0" max="30">
                </div>
                <div id="investmentResultBox"
                    style="margin-top: 16px; margin-bottom: 8px; padding: 14px; background: rgba(59,130,246,0.06); border: 1px solid rgba(59,130,246,0.25); border-radius: 8px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;">
                        <span
                            style="font-size:0.7rem; text-transform:uppercase; letter-spacing:0.05em; color:var(--text-muted);">FV
                            ‚Äî Investimento <br> (al tuo tasso)</span>
                        <span id="outInvestmentValue"
                            style="font-size: 1.15rem; font-weight:700; color: #3b82f6;">--</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;">
                        <span
                            style="font-size:0.7rem; text-transform:uppercase; letter-spacing:0.05em; color:var(--text-muted);">FV
                            ‚Äî Rimborso anticipato <br> (al TAN)</span>
                        <span id="outInvestmentSaving"
                            style="font-size: 1.15rem; font-weight:700; color: #10b981;">--</span>
                    </div>
                    <div id="investmentVerdict"
                        style="margin-top:8px; padding: 8px 10px; border-radius:6px; font-size:0.8rem; font-weight:600; display:none;">
                    </div>
                </div>
                <small id="investmentNote"
                    style="display:block; color:var(--text-muted); font-size:0.72rem; margin-bottom:24px;">
                    ‚ö†Ô∏è Attiva almeno un'estinzione extra o un arrotondamento per abilitare il confronto.
                </small>

                <hr>

                <h3>Sostenibilit√† (DTI) <span class="info-icon"
                        data-tooltip="Debt-to-Income: la percentuale del reddito netto assorbita dalla rata (Soglia consigliata 33%).">i</span>
                </h3>
                <div class="input-group">
                    <label>Reddito Netto Mensile (‚Ç¨)</label>
                    <input type="number" id="monthlyIncome" value="2000" step="100" min="0">
                </div>
                <div class="result-box" style="margin-top: 16px; margin-bottom: 24px; padding: 12px;" id="dtiBox">
                    <span class="label">Rapporto Rata/Reddito</span>
                    <span class="value" id="outDti" style="font-size: 1.2rem;">--</span>
                </div>

                <hr>

                <h3>Indicatore LTV <span class="info-icon"
                        data-tooltip="Loan-to-Value: il rapporto percentuale tra il debito residuo e il valore dell'immobile. Pi√π √® basso, pi√π sei in una posizione solida con la banca.">i</span>
                </h3>
                <small style="display:block; color:var(--text-muted); font-size: 0.75rem; margin-bottom:12px;">
                    Indica quanto del valore della casa √® ancora "della banca". Scende nel tempo man mano che rimborsi
                    il capitale.
                </small>
                <div class="input-group">
                    <label>Valore Immobile (‚Ç¨)
                        <span class="info-icon"
                            data-tooltip="Il valore commerciale stimato dell'immobile. Puoi usare il prezzo d'acquisto o una perizia aggiornata.">i</span>
                    </label>
                    <input type="number" id="propertyValue" value="200000" step="1000" min="0">
                </div>
                <!-- LTV result block -->
                <div id="ltvResultBox" style="margin-top:4px; margin-bottom:24px; display:none;">
                    <div style="display:flex; justify-content:space-between; align-items:baseline; margin-bottom:6px;">
                        <span style="font-size:0.75rem; color:var(--text-muted);">LTV all'accensione</span>
                        <span id="outLtvPercent" style="font-size:1.4rem; font-weight:700;">--%</span>
                    </div>
                    <!-- Barra LTV -->
                    <div
                        style="position:relative; height:10px; background:rgba(255,255,255,0.08); border-radius:99px; margin-bottom:8px; overflow:hidden;">
                        <div id="ltvBar" style="height:100%; border-radius:99px; width:0%; transition:width 0.5s ease;">
                        </div>
                    </div>
                    <!-- Legenda soglie -->
                    <div
                        style="display:flex; justify-content:space-between; font-size:0.68rem; color:var(--text-muted); margin-bottom:6px;">
                        <span>0%</span><span style="color:#10b981;">60% ‚úì</span><span style="color:#f59e0b;">80%
                            ‚ö†</span><span>100%+</span>
                    </div>
                    <div id="ltvMessage"
                        style="font-size:0.78rem; padding:7px 10px; border-radius:6px; font-weight:500;"></div>
                    <small style="display:block; color:var(--text-muted); font-size:0.7rem; margin-top:6px;">Il grafico
                        nel centro mostra l'evoluzione LTV nel tempo.</small>
                </div>

                <hr>

                <h3>Heatmap Interessi <span class="info-icon"
                        data-tooltip="Visualizza graficamente come il peso degli interessi decresce nel tempo (ammortamento alla francese).">i</span>
                </h3>
                <small
                    style="display:block; color:var(--text-muted); font-size: 0.75rem; margin-bottom: 8px;">Distribuzione
                    degli interessi pagati per anno.</small>
                <div id="interestHeatmapContainer"
                    style="display: flex; gap: 2px; height: 32px; background: rgba(0,0,0,0.2); border-radius: 4px; overflow: hidden; margin-bottom: 24px;"
                    data-tooltip="Ogni blocco √® un anno. Pi√π il rosso √® intenso, maggiore √® il peso degli interessi in quel periodo.">
                </div>

                <hr>

                <h3>Salvataggio & Confronto</h3>
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <button id="saveScenario1Btn" class="btn btn-add" style="flex: 1; padding: 8px;">Salva
                        1</button>
                    <button id="loadScenario1Btn" class="btn btn-add"
                        style="flex: 1; padding: 8px; border-style: dashed;">Carica 1</button>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button id="saveScenario2Btn" class="btn btn-add" style="flex: 1; padding: 8px;">Salva
                        2</button>
                    <button id="loadScenario2Btn" class="btn btn-add"
                        style="flex: 1; padding: 8px; border-style: dashed;">Carica 2</button>
                </div>

            </div>
        </div>
    </div>

    <!-- Amortization Drawer -->
    <div id="amortizationDrawer" class="amortization-drawer">
        <div class="drawer-header">
            <h3 style="margin: 0; font-size: 1.1rem; color: var(--text-primary);">Piano Rata per Rata</h3>
            <button id="closeAmortizationBtn" class="btn"
                style="background: transparent; border: none; font-size: 1.2rem; color: var(--text-muted); cursor: pointer; padding: 0;">‚úï</button>
        </div>
        <div class="drawer-content">
            <table class="amortization-table" id="amortizationTable">
                <thead>
                    <tr>
                        <th style="min-width: 40px; text-align: center;">Mese</th>
                        <th style="text-align: right;">Rata</th>
                        <th style="text-align: right;">Interessi</th>
                        <th style="text-align: right;">Extra</th>
                        <th style="text-align: right;">Totale</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Populated by JS -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Moduli Applicativi -->
    <script src="js/globals.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/engine.js"></script>
    <script src="js/ui-manager.js"></script>
    <script src="js/chart-manager.js"></script>
    <script src="js/data/euribor_data.js"></script>
    <script src="js/euribor.js"></script>
    <script src="js/script.js"></script>

    <!-- Floating Tooltip System -->
    <div id="floatingTooltip" class="floating-tooltip"></div>
    <script>
        (function () {
            const tip = document.getElementById('floatingTooltip');
            let hideTimeout = null;

            document.addEventListener('mouseover', function (e) {
                const el = e.target.closest('[data-tooltip]');
                if (!el) return;
                clearTimeout(hideTimeout);
                tip.textContent = el.getAttribute('data-tooltip');

                // Position relative to viewport
                const rect = el.getBoundingClientRect();
                const tipW = 260;
                const tipH = tip.offsetHeight || 60;

                // Show briefly to measure
                tip.style.visibility = 'hidden';
                tip.classList.add('visible');
                tip.style.left = '0px';
                tip.style.top = '0px';
                document.body.appendChild(tip); // ensure in DOM
                const actualH = tip.offsetHeight;
                tip.classList.remove('visible');
                tip.style.visibility = '';

                // Default: above the element
                let top = rect.top - actualH - 8;
                let left = rect.right - tipW;

                // If it goes above the viewport, show below
                if (top < 8) {
                    top = rect.bottom + 8;
                }

                // Clamp horizontally
                if (left < 8) left = 8;
                if (left + tipW > window.innerWidth - 8) {
                    left = window.innerWidth - tipW - 8;
                }

                tip.style.left = left + 'px';
                tip.style.top = top + 'px';
                tip.classList.add('visible');
            });

            document.addEventListener('mouseout', function (e) {
                const el = e.target.closest('[data-tooltip]');
                if (!el) return;
                hideTimeout = setTimeout(function () {
                    tip.classList.remove('visible');
                }, 80);
            });
        })();
    </script>

</body>

</html>